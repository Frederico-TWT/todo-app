name: Update EC2 SSH IPs
on:
  schedule:
    - cron: "0 0 * * 0"   # every Sunday at midnight UTC
  workflow_dispatch:       # allow manual run

jobs:
  update-ips:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Update GitHub IPs in EC2 Security Group
        run: |
          SG_ID="sg-xxxxxxxxxxxx"
          GITHUB_IPS=$(curl -s https://api.github.com/meta | jq -r '.actions[]')

          echo "Revoking old SSH rules..."
          for cidr in $(aws ec2 describe-security-groups --group-ids $SG_ID --query "SecurityGroups[0].IpPermissions" --output json | jq -c '.[] | select(.FromPort==22 and .IpProtocol=="tcp") | .IpRanges[].CidrIp'); do
            aws ec2 revoke-security-group-ingress --group-id $SG_ID --protocol tcp --port 22 --cidr ${cidr//\"/}
          done

          echo "Adding new GitHub IPs..."
          for ip in $GITHUB_IPS; do
            aws ec2 authorize-security-group-ingress --group-id $SG_ID --protocol tcp --port 22 --cidr $ip
          done

          echo "âœ… EC2 Security Group updated with current GitHub Actions IPs."
