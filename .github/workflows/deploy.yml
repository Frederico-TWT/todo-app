name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            sudo npm install -g pnpm@latest

            RELEASE=$(date +%Y%m%d%H%M%S)
            APP_PATH=/var/www/releases/$RELEASE
            CURRENT_PATH=/var/www/current
            PREVIOUS_RELEASE=$(readlink $CURRENT_PATH || true)

            echo "üì¶ Creating new release $RELEASE"
            mkdir -p $APP_PATH

            cd $APP_PATH
            git clone --depth 1 -b main https://github.com/Frederico-TWT/todo-app.git .
            cp /var/www/shared/.env .env

            echo "‚öôÔ∏è Installing dependencies"
            if ! pnpm install --frozen-lockfile; then
              echo "‚ùå Install failed ‚Äî rolling back"
              ln -sfn $PREVIOUS_RELEASE $CURRENT_PATH
              exit 1
            fi

            echo "üèóÔ∏è Building app"
            if ! pnpm build; then
              echo "‚ùå Build failed ‚Äî rolling back"
              ln -sfn $PREVIOUS_RELEASE $CURRENT_PATH
              exit 1
            fi

            echo "üîÅ Linking new release"
            ln -sfn $APP_PATH $CURRENT_PATH

            echo "üöÄ Restarting PM2"
            pm2 delete nextjs-todo-app || true
            pm2 start /home/ubuntu/ecosystem.config.js
            pm2 save

            echo "üßπ Cleaning old releases"
            cd /var/www/releases && ls -t | tail -n +6 | xargs rm -rf -- || true

            echo "‚úÖ Deployment complete"
